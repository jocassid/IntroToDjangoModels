<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Intro to Django ORM</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<!-- <link rel="stylesheet" href="dist/theme/black.css"> -->
		<link rel="stylesheet" href="dist/theme/white.css">
		<link rel="stylesheet" href="dist/custom.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body class="custom">
		<div class="reveal">
			<div class="slides">
				<section>
					<h2 class="custom">Intro to Django ORM</h2>
          <p><a href="https://github.com/jocassid/IntroToDjangoORM">https://github.com/jocassid/IntroToDjangoORM</a></p>
				</section>
				<section>
					<h3 class="custom">What is Django?</h3>
					<p>A Python (<a href="https://www.python.org/">https://www.python.org/</a>) framework primary intended for
						building web applications.</p>
				</section>
				<section>
					<h3>Key Django Features</h3>
					<ul>
						<li>An Object Relational Mapping (ORM) system.</li>
						<li>Views for handling HTTP requests & responses</li>
						<li>A template language for generating HTML (Also supports Jinja templates)</li>
						<li>Authentication system</li>
					</ul>
				</section>
				<section>
					<h3 class="custom">Object Relational Mapping (ORM)</h3>
					<p>A technique for representing database tables as classes in your Python code.</p>
				</section>
        <section>
          <h3>Advantages of ORMS</h3>
          <ul>
            <li>No coding move data between SQL commands and Python code</li>
            <li>ORM code considerably less verbose than SQL statements.</li>
            <li>Helps make your codebase portable between databases.</li>
          </ul>
        </section>
				<section>
					<h3 class="custom">Database items and ORM equivalents</h3>
					<table>
						<thead>
							<tr>
								<th>DB</th>
								<th>ORM</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Table</td>
								<td>Class</td>
							</tr>
							<tr>
								<td>Record</td>
								<td>Instance of Class</td>
							</tr>
							<tr>
								<td>Column of table</td>
								<td>Property of Class</td>
							</tr>
							<tr>
								<td>Field of record</td>
								<td>Property of Instance</td>
							</tr>
						</tbody>
					</table>
				</section>
				<section>
					<h3 class="custom">ORMs in Other Languages</h3>
					<table>
						<tbody>
							<tr>
								<td>Java</td>
								<td>
									<ul>
										<li>Hibernate</li>
										<li>Java Persistence Architecture (JPA)</li>
									</ul>
								</td>
							</tr>
							<tr>
								<td>.Net&nbsp;(C#,&nbsp;etc.)</td>
								<td>Entity Framework</td>
							</tr>
							<tr>
								<td>Ruby</td>
								<td>Ruby on Rails <span class="aside">(Ruby's Django Equivalent)</span></td>
							</tr>
						</tbody>
					</table>
				</section>
				<section>
					<h3 class="custom">SQLAlchemy</h3>
					<div class="aside">(Python's other ORM)</div>
					<table>
						<thead>
							<tr>
								<th>SQLAlchemy</th>
								<th>Django</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>More Powerful</td>
								<td>Less Powerful</td>
							</tr>
							<tr>
								<td>More Difficult to Use</td>
								<td>Easier to Use</td>
							</tr>
							<tr>
								<td></td>
								<td>Integrated with other features of django framework</td>
							</tr>
						</tbody>
					</table>
				</section>
        <section>
					<h3 class="custom">Linux/Unix/MacOS setup</h3>
					<p>The venv standard lib module may be in a separate package from
						your python install.  The command to fix this on Ubuntu Linux &amp;
						derivatives is:</p>
					<pre>
						<code>sudo apt-get install python3-venv</code>
					</pre>
				</section>
				<section>
					<h3 class="custom">Create and Activate Virtual environment</h3>
					<p>Virtual environments are directories where we can install 3rd-party
						libraries without messing up our system-wide Python install.</p>
					<pre>
						<code>
python3 -m venv shopping_list-venv
source shopping_list-venv/bin/activate
# In Powershell use: &amp; shopping_list-venv/Scripts/activate.ps1
						</code>
					</pre>
				</section>
				<section>
					<h3 class="custom">Install Django into Virtual Env</h3>
					<pre>
						<code>pip install django</code>
					</pre>
				</section>
				<section>
					<h3 class="custom">Create Django Project</h3>
					<pre>
						<code>
django-admin startproject shopping_list
cd shopping_list
						</code>
					</pre>
					<h3 class="custom">Contents of shopping_list directory</h3>
					<pre>
						<code>
-rwxrwxr-x 1 john john  669 Sep 15 00:45 manage.py
drwxrwxr-x 2 john john 4.0K Sep 15 00:45 shopping_list
						</code>
					</pre>
					<div class="aside">Be sure to add manage.py to your version control system</div>
				</section>
				<section>
					<h3 class="custom">Add App to Project</h3>
					<pre>
						<code>./manage.py startapp main</code>
					</pre>
				</section>

				<section>
					<h3 class="custom">Add main to the list of installed apps</h3>
					<p>In shopping_list/shopping_list/settings.py</p>
					<pre>
						<code>INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'main',
]</code>
					</pre>
				</section>
        				<section>
					<h3>Contents of Django Project</h3>
					<pre>
						<code>├── main
│   ├── admin.py
│   ├── apps.py
│   ├── __init__.py
│   ├── migrations
│   │   └── __init__.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── manage.py
└── shopping_list
    ├── asgi.py
    ├── __init__.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py
</code>
					</pre>
				</section>
				<section>
					<h3>Database Settings</h3>
					<div class="aside">Most major databases are supported, SQLite is used by default in settings.py</div>
					<pre>
						<code>DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
</code>
					</pre>
				</section>
				<section>
					<h3>Migrations</h3>
					<div class="aside">At this point we just have migrations for Django tables for sessions, users, etc.</div>
					<pre>
						<code>python ./manage.py showmigrations</code>
					</pre>
				</section>
				<section>
					<h3>Apply Migrations</h3>
					<pre>
						<code>python ./manage.py migrate</code>
					</pre>
				</section>
        <section>
          <h3>Creating Our First Model</h3>
          <pre>
            <code>class StoreType(models.Model):

    name = models.CharField(
        max_length=50,
        unique=True,
    )</code>
          </pre>
          <p class="aside">By default, Models get an integer primary key field named 'id'</p>
        </section>
        <section>
          <h3>Make Migrations / Migrate</h3>
          <div class="aside">(Do this after any changes to the models)</div>
          <pre>
            <code>python ./manage.py makemigrations main
python ./manage.py migrate</code>
          </pre>
        </section>
        <section>
          <h3>Create a superuser for your Django Project</h3>
          <pre>
            <code>python ./manage.py createsuperuser</code>
          </pre>
        </section>
        <section>
          <h3 class="custom">Set Up Admin for StoreType</h3>
          <pre>
            <code>from django.contrib import admin
from .models import StoreType

@admin.register(StoreType)
class StoreTypeAdmin(admin.ModelAdmin):
    list_display = ('pk', 'name')</code>
          </pre>
        </section>
        <section>
          <h3 class="custom">Start the Dev Server</h3>
          <pre>
            <code>python ./manage.py runserver</code>
          </pre>

          <p>Navigate to <a href="http://127.0.0.1:8000/admin/">http://127.0.0.1:8000/admin/</a>
          and add a StoreType via the admin interface then hit &lt;CTRL-c&gt;
          at the command line to stop the server.</p>
        </section>
        <section>
          <h3>Open the Django shell</h3>
          <pre>
            <code>python ./manage.py shell</code>
          </pre>
        </section>
        <section>
          <h3>Create Another StoreType Record</h3>
          <pre>
            <code>>>> from main.models import StoreType
>>> store_type = StoreType(name='Grocery')
>>> store_type.save()
>>> store_type.id
2
</code>
          </pre>
          <div class="aside">SQL: <code>INSERT INTO main_storetype (name) VALUES ('main');</code></div>
        </section>
        <section>
          <h3>The one-liner way of creating an object</h3>
          <pre>
            <code>>>> store_type = StoreType.objects.create(name='Pharmacy')
>>> store_type.pk
3</code>
          </pre>
          <p class="aside">model_instance.pk will always return the primary
            key value, no matter what it's named.</p>
        </section>
        <section>
          <h3>List all the StoreTypes in the database</h3>
          <pre>
            <code>>>>StoreType.objects.all()
&lt;QuerySet [&lt;StoreType: StoreType object (1)&gt;, &lt;StoreType: StoreType object (2)&gt;, &lt;StoreType: StoreType object (3)&gt;]></code>
          </pre>
          <div class="aside">SQL: SELECT * FROM main_storetype;</div>
        </section>
        <section>
          <h3>Getting the SQL from a Queryset object</h3>
          <pre>
            <code>>>> str(StoreType.objects.all().query)
'SELECT "main_storetype"."id", "main_storetype"."name" FROM "main_storetype"'</code>
          </pre>
          <div class="aside">I find this equivalent statement more convenient</div>
          <pre>
            <code>StoreType.objects.all().query.__str__()</code>
          </pre>
        </section>
        <section>
          <h3>Add the following to the StoreType class, to make query results more readable</h3>
          <pre>
            <code>    def __repr__(self):
        return f"&lt;StoreType: {self.name} ({self.pk})&gt;"</code>
          </pre>
          <p>Exit the Django shell with &lt;CTRL-z&gt;, restart and import StoreType</p>
          <pre>
            <code>>>> StoreType.objects.all()
&lt;QuerySet [&lt;StoreType: Hardware (1)&gt;, &lt;StoreType: Grocery (2)&gt;, &lt;StoreType: Pharmacy (3)&gt;]></code>
          </pre>
        </section>
        <section>
          <h3>Querysets may be indexed and sliced</h3>
          <pre>
            <code>>>> StoreType.objects.all()[1]
&lt;StoreType: Grocery (2)>
>>> StoreType.objects.all()[1:]
&lt;QuerySet [&lt;StoreType: Grocery (2)>, &lt;StoreType: Pharmacy (3)>]>
>>></code>
          </pre>
        </section>
        <section>
          <h3>Query with a <code>WHERE</code> clause.</h3>
          <pre>
            <code>>>> StoreType.objects.filter(name='Hardware')
&lt;QuerySet [&lt;StoreType: Hardware (1)>]>
>>> StoreType.objects.filter(name='Hardware').query.__str__()
'SELECT "main_storetype"."id", "main_storetype"."name" FROM "main_storetype" WHERE "main_storetype"."name" = Hardware'</code>
          </pre>
        </section>
        <section>
          <h3>Get a Single Record from Table</h3>
          <pre>
            <code>>>> StoreType.objects.get(name='Hardware')
&lt;StoreType: Hardware (1)></code>
          </pre>
          <p>If the record doesn't exist an Exception will be raised</p>
          <pre>
            <code>>>> StoreType.objects.get(name='hardware')
Traceback (most recent call last):
  File "&lt;console>", line 1, in &lt;module>
  File "/home/john/Projects/IntroToDjangoORM/shopping_list-venv/lib/python3.6/site-packages/django/db/models/manager.py", line 85, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File "/home/john/Projects/IntroToDjangoORM/shopping_list-venv/lib/python3.6/site-packages/django/db/models/query.py", line 437, in get
    self.model._meta.object_name
main.models.StoreType.DoesNotExist: StoreType matching query does not exist.</code>
          </pre>
        </section>
        <section>
          <h3>Select specific fields, get results as dictionaries</h3>
          <pre>
            <code>>>> StoreType.objects.values('pk', 'name')
&lt;QuerySet [{'pk': 1, 'name': 'Hardware'}, {'pk': 2, 'name': 'Grocery'}, {'pk': 3, 'name': 'Pharmacy'}]></code>
          </pre>
        </section>
        <section>
          <h3>Select specific fields, get results as tuples</h3>
          <pre>
            <code>>>> StoreType.objects.values_list('pk', 'name')
&lt;QuerySet [(1, 'Hardware'), (2, 'Grocery'), (3, 'Pharmacy')]></code>
          </pre>
        </section>
        <section>
          <h3>When you just want a single field</h3>
          <p class="aside">And don't want tuples of 1 item</p>
          <pre>
            <code>>>> StoreType.objects.values_list('name', flat=True)
&lt;QuerySet ['Hardware', 'Grocery', 'Pharmacy']></code>
          </pre>
        </section>
        <section>
          <h3>Create a second Model</h3>
          <p>In models.py:</p>
          <pre>
            <code>class Store(models.Model):

    name = models.CharField(
        max_length=50,
        unique=True,
    )

    types = models.ManyToManyField(
        StoreType,
        related_name='stores',
    )</code>
          </pre>
        </section>
        <section>
          <h3>And a third</h3>
          <pre>
            <code>class Item(models.Model):

    name = models.CharField(
        max_length=100,
        unique=True,
    )

    price = models.DecimalField(
        max_digits=9,
        decimal_places=2,
        default=0,
    )

    store_type = models.ForeignKey(
        'StoreType',  # Can reference a table using a string
        null=True,  # No value stored as NULL in the database
        blank=True,  # Value is not required to save the record
        on_delete=models.SET_NULL,
        related_name='items',
    )</code>
          </pre>
          <div class="aside">Make and run migrations</div>
        </section>
        <section>
          <h3>Add a ModelAdmin class for Store and Item</h3>
          <pre>
            <code>@admin.register(Item)
class ItemAdmin(admin.ModelAdmin):
    list_display = ('pk', 'name', 'price')

@admin.register(Store)
class StoreAdmin(admin.ModelAdmin):
    list_display = ('pk', 'name')</code>
          </pre>
          <p>runserver and add some Stores and Items via the admin interface</p>
        </section>
        <section>
          <h3>Query With a Join</h3>
          <pre>
            <code>>>> queryset = Item.objects.values_list('name', 'store_type__name')
>>> str(queryset.query)
'SELECT "main_item"."name", "main_storetype"."name" FROM "main_item" LEFT OUTER JOIN "main_storetype" ON ("main_item"."store_type_id" = "main_storetype"."id")'
>>> list(queryset)
[('Tomatoes', 'Grocery'), ('#8 screws 1 1/4 long', 'Hardware'), ('Cold Medicine', 'Pharmacy'), ('Lettuce', 'Grocery'), ('Paint Rollers', 'Hardware')]</code>
          </pre>
        </section>
        <section>
          <h3>Filtering with a Join</h3>
          <pre>
            <code>>>> Item.objects.filter(store_type__name='Grocery')
&lt;QuerySet [&lt;Item: Tomatoes>, &lt;Item: Lettuce>]></code>
          </pre>
        </section>
        <section>
          <h3>exclude</h3>
          <p class="aside">like <code>filter</code>, but in reverse</p>
          <pre>
            <code>>>> Item.objects.exclude(store_type__name='Grocery')
&lt;QuerySet [&lt;Item: #8 screws 1 1/4 long>, &lt;Item: Cold Medicine>, &lt;Item: Paint Rollers>]></code>
          </pre>
        </section>
        <section>
          <h3>Using a field lookup</h3>
          <p class="aside">By default the expressions that we've been using for
            <code>filter</code>, <code>values_list</code>, etc.  Look for an
            exact match, using</p>
          <pre>
            <code>>>> Item.objects.filter(store_type__name__iexact='grocery')
&lt;QuerySet [&lt;Item: Tomatoes>, &lt;Item: Lettuce>]>
</code>
          </pre>
          <p><a href="https://docs.djangoproject.com/en/3.2/topics/db/queries/#field-lookups">Field
            Lookups in Django Documentation</a></p>
        </section>
        <section>
          <h3>Query with a Group by</h3>
          <pre>
            <code>>>> from django.db.models import Count
>>> StoreType.objects.annotate(store_count=Count('stores')).values_list('name', 'store_count')
&lt;QuerySet [('Hardware', 1), ('Grocery', 2), ('Pharmacy', 2)]>
>>> StoreType.objects.annotate(store_count=Count('stores')).values_list('name', 'store_count').query.__str__()
'SELECT "main_storetype"."name", COUNT("main_store_types"."store_id") AS "store_count" FROM "main_storetype" LEFT OUTER JOIN "main_store_types" ON ("main_storetype"."id" = "main_store_types"."storetype_id") GROUP BY "main_storetype"."id", "main_storetype"."name"'</code>
          </pre>
          <p class="aside">With annotate you automatically get the primary key
            field in your GROUP BY expressions</p>
        </section>
        <section>
          <h3>Aggregate across Queryset</h3>
          <pre>
            <code>>>>from django.db.models import Avg
>>> Item.objects.filter(store_type__name='Hardware').values_list('price')
&lt;QuerySet [(Decimal('0.12'),), (Decimal('5.00'),)]>
>>> Item.objects.filter(store_type__name='Hardware').aggregate(avg_price=Avg('price'))
{'avg_price': Decimal('2.56000000000000')}
</code>
          </pre>
        </section>
        <section>
          <h3>select_related</h3>
          <p>In the following a query is executed each time
            <code>item.store_type</code> is accessed.</p>
          <pre>
            <code>for item in Item.objects.all()[:2]:
    print(item, item.store_type)</code>
          </pre>
          <p><code>select_related</code> pulls in the object referenced by
            foreign key</p>
          <pre>
            <code>>>> Item.objects.select_related('store_type')[:3]
&lt;QuerySet [&lt;Item: Tomatoes>, &lt;Item: #8 screws 1 1/4 long>]></code>
          </pre>
        </section>
        <section>
          <h3>prefetch_related</h3>
          <p>Used when traversing a one-to-many or many-to-many relationship</p>
          <pre>
            <code>>>> StoreType.objects.prefetch_related('items')
&lt;QuerySet [&lt;StoreType: Hardware (1)>, &lt;StoreType: Grocery (2)>, &lt;StoreType: Pharmacy (3)>]>
>>> Store.objects.prefetch_related('types')
&lt;QuerySet [&lt;Store: Rousch Hardware (1)>, &lt;Store: Target (2)>, &lt;Store: Kroger (3)>]>
>>> StoreType.objects.prefetch_related('stores')
&lt;QuerySet [&lt;StoreType: Hardware (1)>, &lt;StoreType: Grocery (2)>, &lt;StoreType: Pharmacy (3)>]></code>
          </pre>
        </section>
        <section>
          <h3></h3>
          <pre>
            <code></code>
          </pre>
        </section>
        <section>
          <h3></h3>
          <pre>
            <code></code>
          </pre>
        </section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
